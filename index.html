<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Intelligence Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .api-sources {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 8px;
        }

        .alert-banner {
            background: rgba(231, 76, 60, 0.2);
            border-left: 5px solid #e74c3c;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-banner.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .score-label {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .score-value {
            font-size: 6em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .breakdown-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }

        .breakdown-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .section-score {
            font-size: 1.8em;
            font-weight: bold;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .stock-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stock-card.spiking {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.15);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        .stock-ticker {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stock-price {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .stock-change {
            font-size: 0.95em;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .positive { color: #2ecc71; }
        .negative { color: #e74c3c; }

        .news-list, .reddit-list, .gdelt-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .news-item, .reddit-item, .gdelt-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .news-item.hot, .reddit-item.hot, .gdelt-item.hot {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .item-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .item-meta {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 0.95em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .timestamp {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }

        @media (max-width: 1200px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è US Military Involvement Dashboard</h1>
            <div class="subtitle">
                <span class="live-indicator"></span>
                <span id="marketStatus">Multi-source intelligence monitoring</span>
            </div>
            <div style="max-width: 800px; margin: 15px auto 0; font-size: 0.95em; opacity: 0.85; line-height: 1.5;">
                Multi-source intelligence platform analyzing market signals, news patterns, flight operations, and public discourse to generate probability scores for imminent US military engagement.
            </div>
            <div class="api-sources">Stocks ‚Ä¢ News ‚Ä¢ Military Flights ‚Ä¢ Navy Ships ‚Ä¢ Reddit</div>
        </header>

        <div class="alert-banner" id="alertBanner">
            <strong>‚ö†Ô∏è HIGH ALERT:</strong> <span id="alertText"></span>
        </div>

        <div class="main-score" id="mainScoreCard">
            <div class="score-label">Possible US Military Involvement Score</div>
            <div class="score-value" id="totalScore">--</div>
            <div class="score-breakdown">
                <div class="breakdown-item">
                    <div>üìä Stocks</div>
                    <div class="breakdown-value" id="stockScore">--/30</div>
                </div>
                <div class="breakdown-item">
                    <div>üì∞ News</div>
                    <div class="breakdown-value" id="newsScore">--/30</div>
                </div>
                <div class="breakdown-item">
                    <div>‚úàÔ∏è Flights</div>
                    <div class="breakdown-value" id="flightScore">--</div>
                </div>
                <div class="breakdown-item">
                    <div>‚öì Navy</div>
                    <div class="breakdown-value" id="navyScore">--</div>
                </div>
                <div class="breakdown-item">
                    <div>üí¨ Reddit</div>
                    <div class="breakdown-value" id="redditScore">--/10</div>
                </div>
            </div>
        </div>

        <div class="sections-grid">
            <!-- Stocks Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">üìä Defense Stocks</div>
                    <div class="section-score" id="stockDisplayScore">0</div>
                </div>
                <div class="stocks-grid" id="stocksGrid"></div>
            </div>

            <!-- News Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">üì∞ Military News</div>
                    <div class="section-score" id="newsDisplayScore">0</div>
                </div>
                <div id="newsContent" class="loading">Loading news...</div>
            </div>

            <!-- Military Flights Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">‚úàÔ∏è Military Flights</div>
                    <div class="section-score" id="flightDisplayScore">0</div>
                </div>
                <div id="flightContent" class="loading">Loading flights...</div>
            </div>

            <!-- Navy Ships Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">‚öì Navy Deployments</div>
                    <div class="section-score" id="navyDisplayScore">0</div>
                </div>
                <div id="navyContent" class="loading">Loading Navy data...</div>
            </div>

            <!-- Reddit Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">üí¨ Reddit Activity</div>
                    <div class="section-score" id="redditDisplayScore">0</div>
                </div>
                <div id="redditContent" class="loading">Loading Reddit...</div>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="refreshAllData()" id="refreshBtn">
                <span id="btnText">Refresh All Data</span>
            </button>
        </div>

        <div class="timestamp" id="timestamp">Initializing...</div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            // Cloudflare Worker Proxy - handles all API calls with auth & caching
            WORKER_URL: 'https://trumpstrikes.drewwilson2022.workers.dev',
            UPDATE_INTERVAL: 390000, // 6.5 minutes
            STOCKS: [
                { ticker: 'LMT', name: 'Lockheed Martin' },
                { ticker: 'RTX', name: 'Raytheon' },
                { ticker: 'PLTR', name: 'Palantir' },
                { ticker: 'NOC', name: 'Northrop' },
                { ticker: 'GD', name: 'Gen Dynamics' },
                { ticker: 'LHX', name: 'L3Harris' },
                { ticker: 'BA', name: 'Boeing' }
            ],
            DEFENSE_KEYWORDS: ['US military', 'Pentagon', 'defense contract', 'Air Force', 'USAF', 'DoD', 'defense spending', 'military', 'bomber', 'fighter jet', 'airspace', 'deployed'],
            REDDIT_SUBS: ['worldnews', 'geopolitics', 'news']
        };

        // State
        let scores = {
            stock: 0,
            news: 0,
            flights: 0,
            navy: 0,
            reddit: 0,
            total: 0
        };
        
        // Smart algorithm state
        let historicalData = {
            stocks: [],
            news: [],
            flights: [],
            flightCounts: [],  // Track raw flight counts for baseline
            timestamps: []
        };
        
        let isUpdating = false;
        
        // Smart Algorithm Functions
        
        // Get baseline for normal flight activity
        function getFlightBaseline() {
            if (historicalData.flightCounts.length < 5) return 10; // Default baseline (conservative)
            
            const sum = historicalData.flightCounts.reduce((a, b) => a + b, 0);
            return sum / historicalData.flightCounts.length;
        }
        
        // Check if flight is over continental US (routine = less interesting)
        function isOverContinentalUS(lat, lon) {
            // Continental US approximate bounds
            return lat >= 25 && lat <= 49 && lon >= -125 && lon <= -66;
        }
        
        // Classify callsign importance
        function getCallsignImportance(callsign) {
            const call = callsign.toUpperCase();
            
            // CRITICAL missions (evacuation, VIP, strategic)
            if (call.startsWith('EVAC')) return 5;     // Evacuation = very significant
            if (call.startsWith('SAM')) return 4;      // Special Air Mission (President, VIPs)
            if (call.startsWith('GTMO')) return 4;     // Guantanamo operations
            
            // HIGH priority (strategic airlift, refueling)
            if (call.startsWith('RCH')) return 3;      // Reach (strategic airlift)
            if (call.startsWith('SPAR')) return 3;     // Special Air Resources
            
            // MEDIUM priority (tactical operations)
            if (call.startsWith('VMGR')) return 2;     // Marine refueling
            if (call.startsWith('CNV')) return 2;      // Convoy
            
            // NORMAL operations
            if (call.startsWith('USAF')) return 1;
            if (call.startsWith('USN')) return 1;
            if (call.startsWith('USMC')) return 1;
            if (call.startsWith('ARMY')) return 1;
            if (call.startsWith('NAVY')) return 1;
            
            return 1; // Default
        }
        
        // Detect flight clustering (multiple flights in short time from same area)
        function detectFlightClustering(flights) {
            if (flights.length < 3) return 1.0;
            
            // Check if multiple high-importance flights
            const criticalFlights = flights.filter(f => {
                const importance = getCallsignImportance(f.callsign);
                return importance >= 3;
            });
            
            if (criticalFlights.length >= 2) {
                return 1.5; // Multiple critical missions = 50% bonus
            }
            
            return 1.0;
        }
        
        // Calculate time weight (recent = higher weight)
        function getTimeWeight(timestamp) {
            const now = Date.now();
            const ageMinutes = (now - timestamp) / (1000 * 60);
            
            if (ageMinutes < 60) return 2.0;      // Last hour: 2x weight
            if (ageMinutes < 360) return 1.5;     // Last 6 hours: 1.5x weight
            if (ageMinutes < 1440) return 1.0;    // Last 24 hours: 1x weight
            return 0.5;                            // Older: 0.5x weight
        }
        
        // Detect if signals are clustered in time
        function detectClustering(items, timeWindowMinutes = 60) {
            if (items.length < 2) return 1.0;
            
            const now = Date.now();
            const recentItems = items.filter(item => {
                const age = (now - item.timestamp) / (1000 * 60);
                return age < timeWindowMinutes;
            });
            
            // If 50%+ of items are in the time window, it's clustered
            const clusterRatio = recentItems.length / items.length;
            if (clusterRatio > 0.5) {
                return 1.3; // 30% bonus for clustering
            }
            return 1.0;
        }
        
        // Calculate baseline from historical data
        function getBaseline(historicalArray) {
            if (historicalArray.length < 3) return 0;
            
            const sum = historicalArray.reduce((a, b) => a + b, 0);
            return sum / historicalArray.length;
        }
        
        // Detect cross-source correlation
        function detectCorrelation(stockScore, newsScore, flightScore) {
            let multiplier = 1.0;
            let sources = 0;
            
            // Count how many sources are elevated (>50% of max)
            if (stockScore > 15) sources++; // >50% of 30
            if (newsScore > 15) sources++;  // >50% of 30
            if (flightScore > 15) sources++; // >50% of 30
            
            // Multiple independent sources = higher confidence
            if (sources >= 3) {
                multiplier = 2.0; // All sources elevated = 2x
            } else if (sources === 2) {
                multiplier = 1.5; // Two sources = 1.5x
            }
            
            // Specific high-value correlations
            if (stockScore > 15 && newsScore > 15) {
                multiplier = Math.max(multiplier, 1.6); // Stocks + News together
            }
            
            if (stockScore > 15 && flightScore > 15) {
                multiplier = Math.max(multiplier, 1.4); // Stocks + Flights together
            }
            
            return multiplier;
        }
        
        // Store historical data point
        function recordHistoricalData(type, value) {
            const timestamp = Date.now();
            
            if (!historicalData[type]) historicalData[type] = [];
            
            historicalData[type].push(value);
            historicalData.timestamps.push(timestamp);
            
            // Keep only last 50 data points
            if (historicalData[type].length > 50) {
                historicalData[type].shift();
                historicalData.timestamps.shift();
            }
        }

        // Initialize stocks grid
        function initStocksGrid() {
            const grid = document.getElementById('stocksGrid');
            grid.innerHTML = '';
            
            CONFIG.STOCKS.forEach(stock => {
                const card = document.createElement('div');
                card.className = 'stock-card';
                card.id = `stock-${stock.ticker}`;
                card.innerHTML = `
                    <div class="stock-ticker">${stock.ticker}</div>
                    <div class="stock-price">...</div>
                    <div class="stock-change">--</div>
                `;
                grid.appendChild(card);
            });
        }

        // Fetch stock data
        async function fetchStocks() {
            try {
                const promises = CONFIG.STOCKS.map(async stock => {
                    const url = `${CONFIG.WORKER_URL}/finnhub/quote?symbol=${stock.ticker}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.pc) {
                        return {
                            ticker: stock.ticker,
                            price: data.c || data.pc,
                            change: data.d || 0,
                            changePercent: data.dp || 0
                        };
                    }
                    return null;
                });

                const results = await Promise.all(promises);
                const validResults = results.filter(r => r !== null);

                // Update UI
                validResults.forEach(stock => {
                    const card = document.getElementById(`stock-${stock.ticker}`);
                    if (card) {
                        const isPositive = stock.change >= 0;
                        // Only spike if POSITIVE and >3.5%
                        const isSpiking = stock.changePercent > 3.5;
                        
                        card.className = `stock-card ${isSpiking ? 'spiking' : ''}`;
                        card.innerHTML = `
                            <div class="stock-ticker">${stock.ticker}</div>
                            <div class="stock-price">$${stock.price.toFixed(2)}</div>
                            <div class="stock-change ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '‚ñ≤' : '‚ñº'} ${Math.abs(stock.changePercent).toFixed(2)}%
                            </div>
                        `;
                    }
                });

                // SMART STOCK SCORING (30 points max)
                const upwardSpiking = validResults.filter(s => s.changePercent > 3.5);
                const avgPositiveChange = validResults
                    .filter(s => s.changePercent > 0)
                    .reduce((sum, s) => sum + s.changePercent, 0) / validResults.length;
                
                // Base scores
                let volatilityScore = (upwardSpiking.length / CONFIG.STOCKS.length) * 18;
                let momentumScore = Math.min(12, avgPositiveChange * 2);
                
                // SMART: Detect coordinated movement (3+ stocks moving together = unusual)
                if (upwardSpiking.length >= 3) {
                    volatilityScore *= 1.3; // 30% bonus for coordination
                }
                
                // SMART: Higher spike = more important
                const maxSpike = Math.max(...validResults.map(s => s.changePercent));
                if (maxSpike > 5) {
                    momentumScore *= 1.2; // 20% bonus for strong individual spike
                }
                
                scores.stock = Math.round(volatilityScore + momentumScore);
                
                // Record for historical baseline
                recordHistoricalData('stocks', scores.stock);

                console.log(`Stock score: ${scores.stock} (${upwardSpiking.length} spiking up, max: ${maxSpike.toFixed(2)}%, coordinated: ${upwardSpiking.length >= 3})`);

                console.log(`Stock score: ${scores.stock} (${upwardSpiking} spiking up, avg +${avgPositiveChange.toFixed(2)}%)`);

                return validResults;
            } catch (error) {
                console.error('Stock fetch error:', error);
                return [];
            }
        }

        // Fetch news using RSS feed approach (bypasses News API CORS issue)
        async function fetchNews() {
            try {
                console.log('Fetching news...');
                
                // More specific keywords for US military/defense
                const keywords = '("US military" OR "US Air Force" OR "US Navy" OR "US Army" OR Pentagon OR DoD OR "Department of Defense" OR USAF) AND (deployed OR strike OR aircraft OR base OR mission OR contract OR budget)';
                const fromDate = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString().split('T')[0]; // Last 48 hours
                
                // Use Cloudflare Worker proxy (no API key needed in URL)
                const newsApiUrl = `${CONFIG.WORKER_URL}/news/everything?q=${encodeURIComponent(keywords)}&language=en&sortBy=publishedAt&from=${fromDate}&pageSize=20`;
                
                const response = await fetch(newsApiUrl);
                const data = await response.json();
                console.log('News response:', data);

                if (data.articles && data.articles.length > 0) {
                    const newsContent = document.getElementById('newsContent');
                    newsContent.innerHTML = '<div class="news-list"></div>';
                    const list = newsContent.querySelector('.news-list');

                    let hotCount = 0;
                    let displayedCount = 0;
                    
                    // Filter for US military relevance
                    const usKeywords = ['us military', 'us air force', 'us navy', 'us army', 'pentagon', 'dod', 'department of defense', 'usaf', 'america', 'united states'];
                    
                    data.articles.forEach(article => {
                        if (displayedCount >= 8) return;
                        
                        const title = (article.title || '').toLowerCase();
                        const desc = (article.description || '').toLowerCase();
                        
                        // Must mention US/American military
                        const isUSMilitary = usKeywords.some(kw => title.includes(kw) || desc.includes(kw));
                        
                        if (!isUSMilitary) return; // Skip non-US military articles
                        
                        const isHot = CONFIG.DEFENSE_KEYWORDS.some(kw => 
                            title.includes(kw.toLowerCase()) || desc.includes(kw.toLowerCase())
                        );
                        
                        if (isHot) hotCount++;
                        displayedCount++;

                        const item = document.createElement('div');
                        item.className = `news-item ${isHot ? 'hot' : ''}`;
                        const timeAgo = getTimeAgo(new Date(article.publishedAt));
                        item.innerHTML = `
                            <div class="item-title">${article.title || 'No title'}</div>
                            <div class="item-meta">${article.source?.name || 'Unknown'} ‚Ä¢ ${timeAgo}</div>
                        `;
                        list.appendChild(item);
                    });

                    if (displayedCount === 0) {
                        list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">No recent US military news found</div>';
                        scores.news = 0;
                    } else {
                        // SMART NEWS SCORING (30 points max)
                        let baseScore = hotCount * 3.5 + Math.min(12, displayedCount * 1.2);
                        
                        // SMART: Detect clustering (multiple articles in short time)
                        const articlesWithTime = data.articles.slice(0, displayedCount).map(a => ({
                            timestamp: new Date(a.publishedAt).getTime()
                        }));
                        const clusterBonus = detectClustering(articlesWithTime, 120); // 2 hour window
                        
                        // SMART: Recency weight (recent news = more important)
                        const avgAge = articlesWithTime.reduce((sum, a) => {
                            return sum + (Date.now() - a.timestamp);
                        }, 0) / articlesWithTime.length;
                        const avgAgeHours = avgAge / (1000 * 60 * 60);
                        const recencyBonus = avgAgeHours < 6 ? 1.2 : 1.0;
                        
                        scores.news = Math.min(30, Math.round(baseScore * clusterBonus * recencyBonus));
                        
                        // Record for historical baseline
                        recordHistoricalData('news', scores.news);
                        
                        console.log(`News score: ${scores.news} (${displayedCount} articles, ${hotCount} hot, cluster: ${clusterBonus.toFixed(2)}x, recency: ${recencyBonus.toFixed(2)}x)`);
                    }
                    
                    console.log('News score:', scores.news, `(${displayedCount} articles, ${hotCount} hot)`);
                    
                    // Parse Navy deployments from same articles
                    parseNavyDeployments(data.articles);
                } else {
                    document.getElementById('newsContent').innerHTML = '<div style="padding: 20px; opacity: 0.7;">No recent news found</div>';
                    scores.news = 0;
                }
            } catch (error) {
                console.error('News fetch error:', error);
                document.getElementById('newsContent').innerHTML = `<div style="padding: 20px; opacity: 0.7;">News temporarily unavailable</div>`;
                scores.news = 0;
            }
        }

        // Fetch Military Flights (OpenSky Network)
        async function fetchMilitaryFlights() {
            try {
                console.log('Fetching military flights...');
                
                // Use Cloudflare Worker proxy (handles auth + caching)
                const url = `${CONFIG.WORKER_URL}/opensky/states/all`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('OpenSky response:', data);

                if (data && data.states && Array.isArray(data.states)) {
                    // Filter for US military aircraft only
                    const militaryFlights = data.states.filter(state => {
                        const icao24 = (state[0] || '').toLowerCase();
                        const callsign = (state[1] || '').trim().toUpperCase();
                        
                        // US Military callsign prefixes (strict list)
                        const usMilitaryPrefixes = [
                            'USAF',    // US Air Force
                            'USN',     // US Navy  
                            'USMC',    // US Marine Corps
                            'ARMY',    // US Army
                            'COAST',   // US Coast Guard
                            'RCH',     // Reach (USAF airlift)
                            'CNV',     // Convoy (USAF)
                            'EVAC',    // Evacuation flights
                            'SPAR',    // Special Air Resources (USAF)
                            'HOIST',   // USAF
                            'TREK',    // USAF
                            'NAVY',    // Navy alternative
                            'MARINE',  // Marines alternative
                            'TORCH',   // USAF tankers
                            'GUCCI',   // USAF C-17s
                            'SAM',     // Special Air Mission
                            'VMGR',    // Marine refueling
                            'GTMO'     // Guantanamo
                        ];
                        
                        const hasUSMilitaryCallsign = usMilitaryPrefixes.some(prefix => 
                            callsign.startsWith(prefix)
                        );
                        
                        // US Military ICAO24 codes start with 'ae' (hex for US military)
                        const hasUSMilitaryICAO = icao24.startsWith('ae');
                        
                        // Must have military callsign OR (military ICAO AND non-empty callsign)
                        return hasUSMilitaryCallsign || (hasUSMilitaryICAO && callsign.length > 2);
                    });

                    // SMART FILTERING: Separate significant from routine flights
                    const significantFlights = [];
                    const routineFlights = [];
                    
                    militaryFlights.forEach(state => {
                        const callsign = (state[1] || '').trim();
                        const lat = state[6];
                        const lon = state[5];
                        const importance = getCallsignImportance(callsign);
                        
                        const flightInfo = {
                            callsign: callsign,
                            lat: lat,
                            lon: lon,
                            altitude: state[7],
                            velocity: state[9],
                            icao24: state[0],
                            importance: importance
                        };
                        
                        // SIGNIFICANT if:
                        // 1. High-importance callsign (EVAC, SAM, etc.)
                        // 2. NOT over continental US (international operations)
                        // 3. High altitude + high speed (strategic movement)
                        
                        const isHighImportance = importance >= 3;
                        const isInternational = lat && lon && !isOverContinentalUS(lat, lon);
                        const isStrategic = state[7] > 10000 && state[9] > 200; // High altitude + fast
                        
                        if (isHighImportance || isInternational || isStrategic) {
                            significantFlights.push(flightInfo);
                        } else {
                            routineFlights.push(flightInfo);
                        }
                    });

                    console.log(`Flights: ${militaryFlights.length} total, ${significantFlights.length} significant, ${routineFlights.length} routine`);

                    const flightContent = document.getElementById('flightContent');
                    flightContent.innerHTML = '<div class="news-list"></div>';
                    const list = flightContent.querySelector('.news-list');

                    // Display significant flights only
                    significantFlights.slice(0, 10).forEach(flight => {
                        const altitude = flight.altitude ? `${Math.round(flight.altitude)} m` : 'Unknown';
                        const velocity = flight.velocity ? `${Math.round(flight.velocity * 3.6)} km/h` : 'Unknown';
                        
                        const importanceLabel = flight.importance >= 4 ? 'üî¥ CRITICAL' : 
                                               flight.importance >= 3 ? 'üü† HIGH' : 
                                               flight.importance >= 2 ? 'üü° MEDIUM' : '';
                        
                        const item = document.createElement('div');
                        item.className = `news-item ${flight.importance >= 3 ? 'hot' : ''}`;
                        item.innerHTML = `
                            <div class="item-title">‚úàÔ∏è ${flight.callsign} ${importanceLabel}</div>
                            <div class="item-meta">Alt: ${altitude} ‚Ä¢ Speed: ${velocity} ‚Ä¢ ICAO: ${flight.icao24}</div>
                        `;
                        list.appendChild(item);
                    });

                    // FLIGHT SCORING - Each aircraft worth up to 3.5 points
                    // No cap on total - scales with actual aircraft count
                    
                    const rawFlightCount = militaryFlights.length;
                    const significantCount = significantFlights.length;
                    
                    // Count by mission type
                    const evacuationFlights = significantFlights.filter(f => f.callsign.toUpperCase().startsWith('EVAC'));
                    const samFlights = significantFlights.filter(f => f.callsign.toUpperCase().startsWith('SAM'));
                    const gtmoFlights = significantFlights.filter(f => f.callsign.toUpperCase().startsWith('GTMO'));
                    const strategicFlights = significantFlights.filter(f => {
                        const call = f.callsign.toUpperCase();
                        return call.startsWith('RCH') || call.startsWith('SPAR');
                    });
                    
                    console.log(`Flight breakdown: EVAC=${evacuationFlights.length}, SAM=${samFlights.length}, GTMO=${gtmoFlights.length}, Strategic=${strategicFlights.length}`);

                    let flightScore = 0;
                    let scoreBreakdown = [];
                    
                    // EVAC flights - 3.5 points each (evacuations = critical)
                    if (evacuationFlights.length > 0) {
                        const evacScore = evacuationFlights.length * 3.5;
                        flightScore += evacScore;
                        scoreBreakdown.push(`${evacuationFlights.length} EVAC (${evacScore.toFixed(1)} pts)`);
                    }
                    
                    // SAM flights - 3.0 points each (VIP/Presidential movement)
                    if (samFlights.length > 0) {
                        const samScore = samFlights.length * 3.0;
                        flightScore += samScore;
                        scoreBreakdown.push(`${samFlights.length} SAM (${samScore.toFixed(1)} pts)`);
                    }
                    
                    // GTMO flights - 2.5 points each (detainee operations)
                    if (gtmoFlights.length > 0) {
                        const gtmoScore = gtmoFlights.length * 2.5;
                        flightScore += gtmoScore;
                        scoreBreakdown.push(`${gtmoFlights.length} GTMO (${gtmoScore.toFixed(1)} pts)`);
                    }
                    
                    // Strategic airlift - 1.5 points each (deployment/logistics)
                    if (strategicFlights.length > 0) {
                        const strategicScore = strategicFlights.length * 1.5;
                        flightScore += strategicScore;
                        scoreBreakdown.push(`${strategicFlights.length} Strategic (${strategicScore.toFixed(1)} pts)`);
                    }
                    
                    scores.flights = Math.round(flightScore * 10) / 10; // Round to 1 decimal

                    if (scores.flights === 0) {
                        // NO SCORE - Normal activity
                        list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">‚úÖ Normal military flight activity</div>';
                        console.log('Flight score: 0 (No critical missions detected)');
                    } else {
                        // SCORE - Critical missions detected
                        console.log(`‚ö†Ô∏è Flight score: ${scores.flights} - BREAKDOWN: ${scoreBreakdown.join(', ')}`);
                        
                        // Add alert message to display
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'news-item hot';
                        alertDiv.style.marginBottom = '15px';
                        alertDiv.innerHTML = `
                            <div class="item-title">‚ö†Ô∏è CRITICAL MISSION ACTIVITY DETECTED</div>
                            <div class="item-meta">${scoreBreakdown.join(' ‚Ä¢ ')}</div>
                        `;
                        list.insertBefore(alertDiv, list.firstChild);
                        
                        // Record for historical baseline
                        recordHistoricalData('flights', scores.flights);
                    }
                } else {
                    document.getElementById('flightContent').innerHTML = '<div style="padding: 20px; opacity: 0.7;">No flight data available</div>';
                    scores.flights = 0;
                }
                
            } catch (error) {
                console.error('Flight tracking error:', error);
                document.getElementById('flightContent').innerHTML = `
                    <div style="padding: 20px; opacity: 0.7; text-align: center;">
                        <div style="margin-bottom: 10px;">‚úàÔ∏è Flight tracking unavailable</div>
                        <div style="font-size: 0.85em;">OpenSky Network API requires CORS proxy or backend server.</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">Deploy to a server with network access to enable live flight tracking.</div>
                    </div>
                `;
                scores.flights = 0;
            }
        }

        // Fetch US Navy Ship Deployments from News
        // Only counts MOVEMENTS and DEPLOYMENTS, not stationary presence
        async function fetchNavyDeployments() {
            try {
                console.log('Fetching Navy deployments from news...');
                
                const navyContent = document.getElementById('navyContent');
                navyContent.innerHTML = '<div class="news-list"></div>';
                const list = navyContent.querySelector('.news-list');

                // Search for Navy deployment news
                const navyKeywords = 'US Navy carrier deployed OR "strike group deployed" OR "USS deployed" OR "carrier heading" OR "ships ordered"';
                const fromDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]; // Last 7 days
                const newsApiUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(navyKeywords)}&language=en&sortBy=publishedAt&from=${fromDate}&pageSize=20&apiKey=${CONFIG.NEWS_API_KEY}`;
                
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(newsApiUrl)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                console.log('Navy news response:', data);

                if (data.articles && data.articles.length > 0) {
                    // Keywords that indicate MOVEMENT/DEPLOYMENT (not just presence)
                    const movementKeywords = ['deployed', 'deploying', 'heading to', 'ordered to', 'en route', 'sailing to', 'arriving in', 'transiting', 'departed', 'underway'];
                    
                    // Ship type keywords
                    const carrierKeywords = ['carrier strike group', 'csg', 'cvn', 'uss abraham lincoln', 'uss carl vinson', 'uss theodore roosevelt', 'uss gerald ford', 'uss george washington', 'uss dwight eisenhower', 'uss harry truman', 'uss ronald reagan', 'uss nimitz', 'uss john stennis'];
                    const amphibiousKeywords = ['amphibious ready group', 'arg', 'meu', 'marine expeditionary unit', 'amphibious assault'];
                    const destroyerKeywords = ['destroyer', 'guided missile destroyer', 'ddg', 'cruiser'];
                    
                    // Hotspot regions
                    const hotspots = ['middle east', 'persian gulf', 'iran', 'red sea', 'mediterranean', 'south china sea', 'taiwan strait', 'strait of hormuz', 'gulf of oman', 'arabian sea', 'indo-pacific'];
                    
                    let navyScore = 0;
                    let scoreBreakdown = [];
                    let displayedCount = 0;

                    data.articles.forEach(article => {
                        if (displayedCount >= 8) return;
                        
                        const title = (article.title || '').toLowerCase();
                        const desc = (article.description || '').toLowerCase();
                        const combined = title + ' ' + desc;
                        
                        // Must have MOVEMENT keyword (filtering out "stationed", "currently in", etc.)
                        const hasMovement = movementKeywords.some(kw => combined.includes(kw));
                        if (!hasMovement) return; // Skip if not moving
                        
                        // Check what type of ship and where
                        const hasCarrier = carrierKeywords.some(kw => combined.includes(kw));
                        const hasAmphibious = amphibiousKeywords.some(kw => combined.includes(kw));
                        const hasDestroyers = destroyerKeywords.some(kw => combined.includes(kw));
                        const hasHotspot = hotspots.some(kw => combined.includes(kw));
                        
                        let itemScore = 0;
                        let itemType = '';
                        
                        // Carrier moving to hotspot = highest priority
                        if (hasCarrier && hasHotspot) {
                            itemScore = 5.0;
                            itemType = 'üî¥ CARRIER DEPLOYMENT';
                        }
                        // Amphibious group moving to hotspot
                        else if (hasAmphibious && hasHotspot) {
                            itemScore = 1.5;
                            itemType = 'üü† AMPHIBIOUS DEPLOYMENT';
                        }
                        // Multiple destroyers/surface ships moving
                        else if (hasDestroyers && hasHotspot) {
                            itemScore = 2.5;
                            itemType = 'üü° SURFACE SHIPS DEPLOYMENT';
                        }
                        // Carrier moving anywhere (even non-hotspot)
                        else if (hasCarrier) {
                            itemScore = 2.0;
                            itemType = 'üü† CARRIER MOVEMENT';
                        }
                        // Any significant ship movement
                        else if (hasAmphibious || hasDestroyers) {
                            itemScore = 0.5;
                            itemType = '‚ö™ SHIP MOVEMENT';
                        }
                        
                        if (itemScore > 0) {
                            navyScore += itemScore;
                            scoreBreakdown.push(`${itemType} (${itemScore.toFixed(1)} pts)`);
                            
                            const listItem = document.createElement('div');
                            listItem.className = `news-item ${itemScore >= 3 ? 'hot' : ''}`;
                            const timeAgo = getTimeAgo(new Date(article.publishedAt));
                            listItem.innerHTML = `
                                <div class="item-title">${itemType} ${article.title}</div>
                                <div class="item-meta">${article.source?.name || 'Unknown'} ‚Ä¢ ${timeAgo}</div>
                            `;
                            list.appendChild(listItem);
                            displayedCount++;
                        }
                    });

                    scores.navy = Math.round(navyScore * 10) / 10;

                    if (displayedCount === 0) {
                        list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">‚úÖ No active Navy deployments detected in recent news</div>';
                        scores.navy = 0;
                    }

                    console.log(`‚öì Navy score: ${scores.navy} (${displayedCount} active deployments from news)`);
                    if (scoreBreakdown.length > 0) {
                        console.log(`Navy breakdown: ${scoreBreakdown.join(', ')}`);
                    }
                    
                } else {
                    list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">No Navy news found</div>';
                    scores.navy = 0;
                }
                
            } catch (error) {
                console.error('Navy fetch error:', error);
                document.getElementById('navyContent').innerHTML = `<div style="padding: 20px; opacity: 0.7;">Navy data temporarily unavailable</div>`;
                scores.navy = 0;
            }
        }

        // Parse Navy Carrier Deployments from news articles
        // Tracks ALL 11 US carriers and scores by hotspot risk level
        function parseNavyDeployments(articles) {
            try {
                console.log('Parsing Navy carrier deployments...');
                
                const navyContent = document.getElementById('navyContent');
                navyContent.innerHTML = '<div class="news-list"></div>';
                const list = navyContent.querySelector('.news-list');

                if (!articles || articles.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">No news data for Navy tracking</div>';
                    scores.navy = 0;
                    return;
                }

                // US Navy Carrier Strike Groups (all 11)
                const carriers = [
                    {name: 'Abraham Lincoln', variants: ['abraham lincoln', 'lincoln']},
                    {name: 'Eisenhower', variants: ['eisenhower', 'ike']},
                    {name: 'Carl Vinson', variants: ['carl vinson', 'vinson']},
                    {name: 'Theodore Roosevelt', variants: ['theodore roosevelt', 'tr', 't. roosevelt']},
                    {name: 'George Washington', variants: ['george washington', 'gwash']},
                    {name: 'Harry Truman', variants: ['harry truman', 'truman', 'hst']},
                    {name: 'Ronald Reagan', variants: ['ronald reagan', 'reagan']},
                    {name: 'Nimitz', variants: ['nimitz']},
                    {name: 'John Stennis', variants: ['john stennis', 'stennis']},
                    {name: 'George Bush', variants: ['george bush', 'ghw bush', 'george h.w. bush']},
                    {name: 'Gerald Ford', variants: ['gerald ford', 'ford']}
                ];

                // Hotspot risk levels
                const highRisk = ['iran', 'red sea', 'taiwan strait', 'strait of hormuz', 'houthi', 'yemen'];
                const mediumRisk = ['middle east', 'persian gulf', 'south china sea', 'mediterranean', 'arabian sea', 'gulf of oman'];
                
                // Movement keywords
                const deploymentKeywords = ['deployed', 'deploying', 'heads to', 'heading to', 'en route', 'ordered to', 'transits', 'underway', 'arrives', 'operating in', 'stationed'];
                
                let navyScore = 0;
                let trackedCarriers = [];

                // Check EVERY carrier against ALL articles
                carriers.forEach(carrier => {
                    // Find articles mentioning this carrier
                    const carrierArticles = articles.filter(article => {
                        const combined = `${article.title || ''} ${article.description || ''}`.toLowerCase();
                        // Check if ANY variant of carrier name is mentioned
                        return carrier.variants.some(variant => 
                            combined.includes(variant) || combined.includes(`uss ${variant}`)
                        );
                    });

                    if (carrierArticles.length > 0) {
                        // Check ALL articles for this carrier to find highest risk deployment
                        let bestMatch = null;
                        let highestRisk = 0;

                        carrierArticles.forEach(article => {
                            const combined = `${article.title || ''} ${article.description || ''}`.toLowerCase();
                            
                            // Check for movement/deployment
                            const hasMovement = deploymentKeywords.some(kw => combined.includes(kw));
                            
                            // Determine risk level
                            let points = 0;
                            let region = '';
                            let riskLevel = '';
                            
                            if (highRisk.some(loc => combined.includes(loc))) {
                                points = 3.0;
                                region = highRisk.find(loc => combined.includes(loc));
                                riskLevel = 'üî¥ HIGH RISK';
                            } else if (mediumRisk.some(loc => combined.includes(loc))) {
                                points = 1.5;
                                region = mediumRisk.find(loc => combined.includes(loc));
                                riskLevel = 'üü† MEDIUM RISK';
                            } else if (hasMovement) {
                                // Has movement but not in tracked region - skip (0 points)
                                points = 0;
                            }
                            
                            // Keep highest risk deployment for this carrier
                            if (points > highestRisk) {
                                highestRisk = points;
                                bestMatch = {
                                    name: `USS ${carrier.name}`,
                                    region: region.toUpperCase(),
                                    riskLevel: riskLevel,
                                    points: points,
                                    article: article
                                };
                            }
                        });

                        // Add carrier if it's in a risk zone
                        if (bestMatch && bestMatch.points > 0) {
                            navyScore += bestMatch.points;
                            trackedCarriers.push(bestMatch);
                            console.log(`Found: ${bestMatch.name} in ${bestMatch.region} (${bestMatch.points} pts)`);
                        }
                    }
                });

                // Display tracked carriers
                if (trackedCarriers.length > 0) {
                    // Sort by risk (highest first)
                    trackedCarriers.sort((a, b) => b.points - a.points);
                    
                    trackedCarriers.forEach(carrier => {
                        const item = document.createElement('div');
                        item.className = `news-item ${carrier.points >= 2.5 ? 'hot' : ''}`;
                        const timeAgo = getTimeAgo(new Date(carrier.article.publishedAt));
                        item.innerHTML = `
                            <div class="item-title">${carrier.riskLevel} ${carrier.name} - ${carrier.region}</div>
                            <div class="item-meta">${carrier.article.source?.name || 'News'} ‚Ä¢ ${timeAgo} ‚Ä¢ ${carrier.points.toFixed(1)} pts</div>
                        `;
                        list.appendChild(item);
                    });
                    
                    scores.navy = Math.round(navyScore * 10) / 10;
                    console.log(`‚öì Navy: ${scores.navy} pts (${trackedCarriers.length} carriers in risk zones)`);
                } else {
                    list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">‚úÖ No carriers detected in high/medium risk zones</div>';
                    scores.navy = 0;
                    console.log('Navy: 0 pts (No carriers in risk zones)');
                }
                
            } catch (error) {
                console.error('Navy parse error:', error);
                document.getElementById('navyContent').innerHTML = '<div style="padding: 20px; opacity: 0.7;">Navy tracking error</div>';
                scores.navy = 0;
            }
        }

        // Fetch Reddit posts
        async function fetchReddit() {
            try {
                console.log('Fetching Reddit...');
                const redditContent = document.getElementById('redditContent');
                redditContent.innerHTML = '<div class="reddit-list"></div>';
                const list = redditContent.querySelector('.reddit-list');

                let allPosts = [];
                let hotCount = 0;

                // Fetch from multiple subreddits
                for (const sub of CONFIG.REDDIT_SUBS) {
                    try {
                        const url = `https://www.reddit.com/r/${sub}/new.json?limit=10`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            console.log(`Reddit r/${sub} returned ${response.status}`);
                            continue;
                        }
                        
                        const data = await response.json();
                        console.log(`Reddit r/${sub} data:`, data);
                        
                        if (data.data && data.data.children) {
                            allPosts = allPosts.concat(data.data.children);
                        }
                    } catch (e) {
                        console.log(`Error fetching r/${sub}:`, e);
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Filter and score posts
                const relevantPosts = allPosts.filter(post => {
                    const title = post.data.title?.toLowerCase() || '';
                    const selftext = post.data.selftext?.toLowerCase() || '';
                    return CONFIG.DEFENSE_KEYWORDS.some(kw => 
                        title.includes(kw.toLowerCase()) || selftext.includes(kw.toLowerCase())
                    );
                });

                console.log(`Found ${relevantPosts.length} relevant Reddit posts`);

                if (relevantPosts.length > 0) {
                    relevantPosts.slice(0, 8).forEach(post => {
                        const isHot = post.data.score > 100 || post.data.num_comments > 50;
                        if (isHot) hotCount++;

                        const item = document.createElement('div');
                        item.className = `reddit-item ${isHot ? 'hot' : ''}`;
                        const timeAgo = getTimeAgo(new Date(post.data.created_utc * 1000));
                        item.innerHTML = `
                            <div class="item-title">${post.data.title}</div>
                            <div class="item-meta">r/${post.data.subreddit} ‚Ä¢ ‚Üë${post.data.score} ‚Ä¢ ${post.data.num_comments} comments ‚Ä¢ ${timeAgo}</div>
                        `;
                        list.appendChild(item);
                    });

                    // Calculate Reddit score (10 points max)
                    scores.reddit = Math.min(10, relevantPosts.length + hotCount * 2);
                } else {
                    list.innerHTML = '<div style="padding: 20px; opacity: 0.7;">No relevant defense posts found</div>';
                    scores.reddit = 0;
                }
                
                console.log('Reddit score:', scores.reddit);
            } catch (error) {
                console.error('Reddit fetch error:', error);
                document.getElementById('redditContent').innerHTML = `<div class="error">Reddit error: ${error.message}</div>`;
                scores.reddit = 0;
            }
        }

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Update scores display
        function updateScoresDisplay() {
            // SMART TOTAL SCORE CALCULATION
            
            // 1. Get individual scores
            const rawTotal = scores.stock + scores.news + scores.flights + scores.navy + scores.reddit;
            
            // 2. Detect cross-source correlation
            const correlationMultiplier = detectCorrelation(scores.stock, scores.news, scores.flights);
            
            // 3. Apply correlation bonus
            const correlatedScore = rawTotal * correlationMultiplier;
            
            // 4. Calculate baseline deviation (if we have history)
            let baselineMultiplier = 1.0;
            if (historicalData.stocks.length > 5) {
                const historicalAvg = (
                    getBaseline(historicalData.stocks) +
                    getBaseline(historicalData.news) +
                    getBaseline(historicalData.flights)
                ) / 3;
                
                const currentAvg = (scores.stock + scores.news + scores.flights) / 3;
                
                if (historicalAvg > 0) {
                    const deviation = currentAvg / historicalAvg;
                    // If current is 2x+ above baseline, it's significant
                    if (deviation > 2) {
                        baselineMultiplier = 1.2; // 20% bonus for unusual activity
                    }
                }
            }
            
            // 5. Final score
            scores.total = Math.min(100, Math.round(correlatedScore * baselineMultiplier));

            // Update UI
            document.getElementById('totalScore').textContent = scores.total.toFixed(1);
            document.getElementById('stockScore').textContent = scores.stock.toFixed(1);
            document.getElementById('newsScore').textContent = scores.news.toFixed(1);
            document.getElementById('flightScore').textContent = scores.flights.toFixed(1);
            document.getElementById('navyScore').textContent = scores.navy.toFixed(1);
            document.getElementById('redditScore').textContent = scores.reddit.toFixed(1);

            document.getElementById('stockDisplayScore').textContent = scores.stock.toFixed(1);
            document.getElementById('newsDisplayScore').textContent = scores.news.toFixed(1);
            document.getElementById('flightDisplayScore').textContent = scores.flights.toFixed(1);
            document.getElementById('navyDisplayScore').textContent = scores.navy.toFixed(1);
            document.getElementById('redditDisplayScore').textContent = scores.reddit.toFixed(1);
            
            // Log smart algorithm details
            console.log('=== SMART ALGORITHM ===');
            console.log(`Raw total: ${rawTotal}`);
            console.log(`Correlation multiplier: ${correlationMultiplier.toFixed(2)}x`);
            console.log(`Baseline multiplier: ${baselineMultiplier.toFixed(2)}x`);
            console.log(`Final score: ${scores.total}/100`);

            // Color code the main score card based on thresholds
            const scoreCard = document.getElementById('mainScoreCard');
            if (scores.total <= 35) {
                scoreCard.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
            } else if (scores.total <= 55) {
                scoreCard.style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
            } else if (scores.total <= 79) {
                scoreCard.style.background = 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)';
            } else {
                scoreCard.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            }

            // Alert banner with smart context
            const alertBanner = document.getElementById('alertBanner');
            const alertText = document.getElementById('alertText');

            if (scores.total >= 65) {
                let alertMessage = `High activity detected (Score: ${scores.total}/100)`;
                
                if (correlationMultiplier > 1.3) {
                    alertMessage += ` - Multiple sources correlated`;
                }
                if (baselineMultiplier > 1.1) {
                    alertMessage += ` - Above historical baseline`;
                }
                
                alertMessage += ` | Stocks: ${scores.stock}, News: ${scores.news}, Flights: ${scores.flights}, Navy: ${scores.navy}, Reddit: ${scores.reddit}`;
                
                alertText.textContent = alertMessage;
                alertBanner.classList.add('active');
            } else {
                alertBanner.classList.remove('active');
            }
        }

        // Refresh all data
        async function refreshAllData() {
            if (isUpdating) return;
            
            isUpdating = true;
            const btn = document.getElementById('refreshBtn');
            const btnText = document.getElementById('btnText');
            btn.disabled = true;
            btnText.textContent = 'Updating...';

            try {
                // Fetch all sources in parallel
                await Promise.all([
                    fetchStocks(),
                    fetchNews(), // This also calls parseNavyDeployments()
                    fetchMilitaryFlights(),
                    fetchReddit()
                ]);

                updateScoresDisplay();
                
                const now = new Date();
                document.getElementById('timestamp').innerHTML = 
                    `Last updated: ${now.toLocaleTimeString()}<br><br>Website built by <a style="color:white" href="https://drew.cx" target="_blank">Drew Wilson</a>.<br><br>API Design by <a href="https://judes.club" style="color:white" target="_blank">Alec Wilson</a>.`;
                
            } catch (error) {
                console.error('Update error:', error);
            } finally {
                isUpdating = false;
                btn.disabled = false;
                btnText.textContent = 'Refresh All Data';
            }
        }

        // Initialize
        async function init() {
            console.log('üõ°Ô∏è Defense Intelligence Dashboard Starting...');
            
            initStocksGrid();
            await refreshAllData();
            
            // Auto-refresh every 6.5 minutes
            setInterval(refreshAllData, CONFIG.UPDATE_INTERVAL);
            
            console.log('‚úÖ Dashboard ready!');
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>