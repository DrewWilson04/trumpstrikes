<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Military Intelligence Dashboard - AI Prediction System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0e27;
            color: #00ff41;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #00ff41;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 0 0 10px #00ff41;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #0f0;
            font-size: 1.1em;
            opacity: 0.8;
        }

        .status-bar {
            background: #0d1117;
            border: 1px solid #00ff41;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #0d1117;
            border: 1px solid #00ff41;
            padding: 20px;
            border-radius: 5px;
        }

        .panel h2 {
            color: #00ff41;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 1px solid #00ff41;
            padding-bottom: 10px;
        }

        .threat-meter {
            width: 100%;
            height: 40px;
            background: #1a1f36;
            border: 1px solid #00ff41;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }

        .threat-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41 0%, #ffff00 50%, #ff0000 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .region-list {
            list-style: none;
        }

        .region-item {
            background: #1a1f36;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #00ff41;
        }

        .region-score {
            float: right;
            background: #00ff41;
            color: #000;
            padding: 2px 10px;
            border-radius: 3px;
            font-weight: bold;
        }

        .indicator-list {
            margin-top: 15px;
        }

        .indicator {
            background: #1a1f36;
            padding: 8px;
            margin: 8px 0;
            border-left: 2px solid #00ff41;
            font-size: 0.9em;
        }

        .probability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .probability-card {
            background: #1a1f36;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
        }

        .probability-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .probability-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff41;
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stock-card {
            background: #1a1f36;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
        }

        .stock-symbol {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .stock-price {
            font-size: 1.2em;
            margin: 5px 0;
        }

        .stock-change {
            font-size: 0.9em;
        }

        .positive {
            color: #00ff41;
        }

        .negative {
            color: #ff4444;
        }

        .news-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .news-item {
            background: #1a1f36;
            padding: 12px;
            margin: 10px 0;
            border-left: 2px solid #00ff41;
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .news-source {
            font-size: 0.8em;
            opacity: 0.6;
        }

        .flight-count {
            font-size: 3em;
            text-align: center;
            margin: 20px 0;
            color: #00ff41;
            text-shadow: 0 0 20px #00ff41;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            opacity: 0.7;
        }

        .error {
            background: #ff4444;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .timestamp {
            font-size: 0.8em;
            opacity: 0.6;
            text-align: right;
            margin-top: 10px;
        }

        .model-badge {
            display: inline-block;
            background: #00ff41;
            color: #000;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .executive-summary {
            background: #1a1f36;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #00ff41;
            line-height: 1.8;
        }

        .scenario-box {
            background: #1a1f36;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid #ffff00;
        }

        .controls {
            margin-bottom: 20px;
            text-align: center;
        }

        button {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 0 10px;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #00cc33;
            box-shadow: 0 0 15px #00ff41;
        }

        button:active {
            transform: scale(0.95);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .probability-grid {
                grid-template-columns: 1fr;
            }
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° MILITARY INTELLIGENCE DASHBOARD ‚ö°</h1>
            <div class="subtitle">AI-Powered US Military Action Prediction System</div>
            <div class="subtitle" style="font-size: 0.9em; margin-top: 10px;">
                <span id="currentTime"></span> EST
            </div>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">SYSTEM STATUS</div>
                <div class="status-value" id="systemStatus">INITIALIZING...</div>
            </div>
            <div class="status-item">
                <div class="status-label">LAST QUICK SCAN (4o-mini)</div>
                <div class="status-value" id="lastMini">--:--</div>
            </div>
            <div class="status-item">
                <div class="status-label">LAST DEEP ANALYSIS (4o)</div>
                <div class="status-value" id="lastDeep">--:--</div>
            </div>
            <div class="status-item">
                <div class="status-label">NEXT UPDATE</div>
                <div class="status-value blink" id="nextUpdate">CALCULATING...</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="runMiniAnalysis()">üîÑ RUN QUICK SCAN</button>
            <button onclick="runDeepAnalysis()">üîç RUN DEEP ANALYSIS</button>
            <button onclick="refreshAll()">‚ôªÔ∏è REFRESH ALL DATA</button>
        </div>

        <!-- Latest AI Analysis -->
        <div class="panel">
            <h2>ü§ñ LATEST AI THREAT ASSESSMENT <span class="model-badge" id="latestModel">--</span></h2>
            <div class="threat-meter">
                <div class="threat-fill" id="threatFill" style="width: 0%;">
                    <span id="threatScore">--</span>
                </div>
            </div>
            <div id="latestAnalysis" class="loading">Waiting for analysis...</div>
        </div>

        <!-- Grid Layout -->
        <div class="grid">
            <!-- Quick Scan Results -->
            <div class="panel">
                <h2>‚ö° QUICK SCAN (GPT-4o-mini)</h2>
                <div id="miniAnalysis" class="loading">No recent scan...</div>
            </div>

            <!-- Deep Analysis Results -->
            <div class="panel">
                <h2>üîç DEEP ANALYSIS (GPT-4o)</h2>
                <div id="deepAnalysis" class="loading">No recent analysis...</div>
            </div>
        </div>

        <!-- Defense Stocks -->
        <div class="panel">
            <h2>üìà DEFENSE CONTRACTOR STOCKS</h2>
            <div class="stock-grid" id="stockGrid">
                <div class="loading">Loading stocks...</div>
            </div>
        </div>

        <div class="grid">
            <!-- Military Flights -->
            <div class="panel">
                <h2>‚úàÔ∏è MILITARY FLIGHT ACTIVITY</h2>
                <div class="flight-count" id="flightCount">--</div>
                <div style="text-align: center; opacity: 0.7;">Active Military Aircraft</div>
                <div id="flightDetails"></div>
            </div>

            <!-- Latest News -->
            <div class="panel">
                <h2>üì∞ LATEST INTELLIGENCE</h2>
                <div class="news-list" id="newsList">
                    <div class="loading">Loading news...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://trumpstrikes.drewwilson2022.workers.dev';
        let refreshInterval;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            refreshAll();
            // Auto-refresh every 2 minutes
            refreshInterval = setInterval(refreshAll, 120000);
        });

        function updateClock() {
            const now = new Date();
            const est = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            document.getElementById('currentTime').textContent = est.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        async function refreshAll() {
            document.getElementById('systemStatus').textContent = 'SCANNING...';
            
            await Promise.all([
                loadAnalysis(),
                loadStocks(),
                loadFlights(),
                loadNews()
            ]);

            document.getElementById('systemStatus').textContent = 'OPERATIONAL';
        }

        async function loadAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/api/analysis`);
                const data = await response.json();

                // Update status bar
                if (data.lastMiniRun) {
                    const miniTime = new Date(data.lastMiniRun);
                    document.getElementById('lastMini').textContent = miniTime.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                if (data.lastDeepRun) {
                    const deepTime = new Date(data.lastDeepRun);
                    document.getElementById('lastDeep').textContent = deepTime.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                // Display latest analysis (prefer deep over mini)
                const latest = data.deep || data.mini;
                if (latest) {
                    displayLatestAnalysis(latest);
                }

                // Display mini analysis
                if (data.mini) {
                    displayMiniAnalysis(data.mini);
                }

                // Display deep analysis
                if (data.deep) {
                    displayDeepAnalysis(data.deep);
                }

            } catch (error) {
                console.error('Error loading analysis:', error);
                document.getElementById('latestAnalysis').innerHTML = `<div class="error">Failed to load analysis: ${error.message}</div>`;
            }
        }

        function displayLatestAnalysis(analysis) {
            const threatLevel = analysis.threatLevel || 50;
            document.getElementById('threatFill').style.width = `${threatLevel}%`;
            document.getElementById('threatScore').textContent = `THREAT LEVEL: ${threatLevel}/100`;
            document.getElementById('latestModel').textContent = analysis.model || 'GPT-4o';

            let html = '';

            if (analysis.summary) {
                html += `<div class="executive-summary">${analysis.summary}</div>`;
            }

            if (analysis.executiveSummary) {
                html += `<div class="executive-summary">${analysis.executiveSummary}</div>`;
            }

            if (analysis.probability) {
                html += `<div style="text-align: center; margin: 20px 0; font-size: 1.5em;">
                    <strong>30-Day Action Probability: ${analysis.probability}%</strong>
                </div>`;
            }

            if (analysis.regions && Array.isArray(analysis.regions)) {
                html += '<h3 style="margin-top: 20px;">Top Regions of Concern:</h3><ul class="region-list">';
                analysis.regions.forEach(region => {
                    if (typeof region === 'string') {
                        html += `<li class="region-item">${region}</li>`;
                    } else {
                        html += `<li class="region-item">
                            ${region.name || region}
                            ${region.score ? `<span class="region-score">${region.score}</span>` : ''}
                            ${region.reasoning ? `<div style="margin-top: 5px; font-size: 0.9em; opacity: 0.8;">${region.reasoning}</div>` : ''}
                        </li>`;
                    }
                });
                html += '</ul>';
            }

            document.getElementById('latestAnalysis').innerHTML = html;
        }

        function displayMiniAnalysis(analysis) {
            let html = `<div class="timestamp">Updated: ${new Date(analysis.timestamp).toLocaleString()}</div>`;

            html += `<div style="font-size: 1.2em; margin: 15px 0;">
                <strong>Threat Level: ${analysis.threatLevel}/100</strong>
            </div>`;

            if (analysis.probability) {
                html += `<div style="font-size: 1.1em; margin: 10px 0;">
                    30-Day Probability: <strong>${analysis.probability}%</strong>
                </div>`;
            }

            if (analysis.summary) {
                html += `<div class="executive-summary">${analysis.summary}</div>`;
            }

            if (analysis.regions) {
                html += '<h3 style="margin-top: 15px;">Key Regions:</h3><ul class="region-list">';
                analysis.regions.forEach(region => {
                    html += `<li class="region-item">${region}</li>`;
                });
                html += '</ul>';
            }

            if (analysis.indicators) {
                html += '<h3 style="margin-top: 15px;">Key Indicators:</h3><div class="indicator-list">';
                if (Array.isArray(analysis.indicators)) {
                    analysis.indicators.forEach(indicator => {
                        html += `<div class="indicator">${indicator}</div>`;
                    });
                }
                html += '</div>';
            }

            document.getElementById('miniAnalysis').innerHTML = html;
        }

        function displayDeepAnalysis(analysis) {
            let html = `<div class="timestamp">Updated: ${new Date(analysis.timestamp).toLocaleString()}</div>`;

            html += `<div style="font-size: 1.2em; margin: 15px 0;">
                <strong>Threat Level: ${analysis.threatLevel}/100</strong>
                ${analysis.confidenceInterval ? ` (CI: ${analysis.confidenceInterval})` : ''}
            </div>`;

            if (analysis.probabilities) {
                html += '<div class="probability-grid">';
                html += `<div class="probability-card">
                    <div class="probability-label">7 Days</div>
                    <div class="probability-value">${analysis.probabilities['7day'] || analysis.probabilities.sevenDay || '--'}%</div>
                </div>`;
                html += `<div class="probability-card">
                    <div class="probability-label">30 Days</div>
                    <div class="probability-value">${analysis.probabilities['30day'] || analysis.probabilities.thirtyDay || '--'}%</div>
                </div>`;
                html += `<div class="probability-card">
                    <div class="probability-label">90 Days</div>
                    <div class="probability-value">${analysis.probabilities['90day'] || analysis.probabilities.ninetyDay || '--'}%</div>
                </div>`;
                html += '</div>';
            }

            if (analysis.executiveSummary) {
                html += `<div class="executive-summary">${analysis.executiveSummary}</div>`;
            }

            if (analysis.regions && Array.isArray(analysis.regions)) {
                html += '<h3 style="margin-top: 20px;">Regional Breakdown:</h3><ul class="region-list">';
                analysis.regions.forEach(region => {
                    html += `<li class="region-item">
                        ${region.name || region}
                        ${region.score ? `<span class="region-score">${region.score}/100</span>` : ''}
                        ${region.reasoning ? `<div style="margin-top: 5px; font-size: 0.9em; opacity: 0.8;">${region.reasoning}</div>` : ''}
                    </li>`;
                });
                html += '</ul>';
            }

            if (analysis.scenarios) {
                html += '<h3 style="margin-top: 20px;">Likely Scenarios:</h3>';
                if (Array.isArray(analysis.scenarios)) {
                    analysis.scenarios.forEach(scenario => {
                        html += `<div class="scenario-box">${scenario}</div>`;
                    });
                }
            }

            document.getElementById('deepAnalysis').innerHTML = html;
        }

        async function loadStocks() {
            const symbols = ['LMT', 'RTX', 'NOC', 'GD', 'BA', 'HII', 'LHX'];
            let html = '';

            for (const symbol of symbols) {
                try {
                    const response = await fetch(`${API_BASE}/api/stock/${symbol}`);
                    const stock = await response.json();

                    const changeClass = stock.changePercent >= 0 ? 'positive' : 'negative';
                    const changeSymbol = stock.changePercent >= 0 ? '‚ñ≤' : '‚ñº';

                    html += `
                        <div class="stock-card">
                            <div class="stock-symbol">${stock.symbol}</div>
                            <div class="stock-price">$${stock.price?.toFixed(2) || '--'}</div>
                            <div class="stock-change ${changeClass}">
                                ${changeSymbol} ${Math.abs(stock.changePercent || 0).toFixed(2)}%
                            </div>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div class="stock-card">
                            <div class="stock-symbol">${symbol}</div>
                            <div class="stock-price">ERROR</div>
                        </div>
                    `;
                }
            }

            document.getElementById('stockGrid').innerHTML = html;
        }

        async function loadFlights() {
            try {
                const response = await fetch(`${API_BASE}/api/flights`);
                const data = await response.json();

                document.getElementById('flightCount').textContent = data.count || 0;

                let html = '<div style="margin-top: 20px; max-height: 200px; overflow-y: auto;">';
                if (data.flights && data.flights.length > 0) {
                    data.flights.slice(0, 10).forEach(flight => {
                        html += `<div style="background: #1a1f36; padding: 8px; margin: 5px 0; font-size: 0.9em;">
                            <strong>${flight.callsign || 'Unknown'}</strong> - 
                            Alt: ${Math.round(flight.altitude || 0)}m - 
                            Vel: ${Math.round(flight.velocity || 0)}m/s
                        </div>`;
                    });
                }
                html += '</div>';

                document.getElementById('flightDetails').innerHTML = html;
            } catch (error) {
                document.getElementById('flightCount').textContent = 'ERR';
                console.error('Error loading flights:', error);
            }
        }

        async function loadNews() {
            try {
                const response = await fetch(`${API_BASE}/api/news`);
                const data = await response.json();

                let html = '';
                if (data.articles && data.articles.length > 0) {
                    data.articles.slice(0, 15).forEach(article => {
                        html += `
                            <div class="news-item">
                                <div class="news-title">${article.title}</div>
                                <div class="news-source">${article.source?.name || 'Unknown'} - ${new Date(article.publishedAt).toLocaleDateString()}</div>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="loading">No news available</div>';
                }

                document.getElementById('newsList').innerHTML = html;
            } catch (error) {
                document.getElementById('newsList').innerHTML = `<div class="error">Failed to load news: ${error.message}</div>`;
                console.error('Error loading news:', error);
            }
        }

        async function runMiniAnalysis() {
            document.getElementById('systemStatus').textContent = 'RUNNING QUICK SCAN...';
            try {
                const response = await fetch(`${API_BASE}/api/run-mini`);
                const data = await response.json();
                await loadAnalysis();
                document.getElementById('systemStatus').textContent = 'OPERATIONAL';
                alert('Quick scan complete!');
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'ERROR';
                alert('Quick scan failed: ' + error.message);
            }
        }

        async function runDeepAnalysis() {
            document.getElementById('systemStatus').textContent = 'RUNNING DEEP ANALYSIS...';
            try {
                const response = await fetch(`${API_BASE}/api/run-deep`);
                const data = await response.json();
                await loadAnalysis();
                document.getElementById('systemStatus').textContent = 'OPERATIONAL';
                alert('Deep analysis complete!');
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'ERROR';
                alert('Deep analysis failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
